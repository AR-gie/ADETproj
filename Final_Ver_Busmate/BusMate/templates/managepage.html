<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage - BusMate</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='Index.css') }}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .filter-section {
      background: var(--card-white);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 20px;
      box-shadow: 0 6px 14px rgba(10,40,80,0.04);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-size: 12px;
      font-weight: 600;
      color: var(--deep-blue);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .filter-group input,
    .filter-group select {
      padding: 10px 12px;
      border: 1px solid #d0dce6;
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(18, 62, 138, 0.1);
      background-color: #f8fbff;
    }

    .filter-buttons button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter-buttons .btn-apply {
      background: linear-gradient(180deg, #174a8b, #0b4b9b);
      color: white;
      flex: 1;
    }

    .filter-buttons .btn-reset {
      background: #f0f4f8;
      color: var(--deep-blue);
      flex: 1;
    }

    .view-button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.3);
      color: var(--deep-blue);
    }

    .view-button:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .view-button.active {
      background: linear-gradient(180deg, #174a8b, #0b4b9b);
      color: white;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .chart-container {
      background: var(--card-white);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 14px rgba(10,40,80,0.04);
      position: relative;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--deep-blue);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
    }

    .customer-types-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .customer-types-list li {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e8eef5;
      font-size: 13px;
    }

    .customer-types-list li:last-child {
      border-bottom: none;
    }

    .customer-types-list .type-label {
      font-weight: 600;
      color: var(--deep-blue);
    }

    .customer-types-list .type-count {
      color: #666;
    }

    .routes-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .routes-list li {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid #e8eef5;
      font-size: 12px;
      align-items: center;
    }

    .routes-list li:last-child {
      border-bottom: none;
    }

    .routes-list .route-name {
      font-weight: 600;
      color: var(--deep-blue);
      word-break: break-word;
    }

    .routes-list .route-stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .routes-list .stat-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      background-color: #f0f4f8;
      color: #333;
      font-weight: 500;
      font-size: 11px;
    }

    .routes-list .stat-badge.from {
      background-color: rgba(30, 95, 160, 0.1);
      color: #1e5fa0;
    }

    .routes-list .stat-badge.to {
      background-color: rgba(39, 167, 69, 0.1);
      color: #27a745;
    }

    .routes-list .stat-badge.combined {
      background-color: rgba(243, 156, 18, 0.1);
      color: #f39c12;
    }

    .color-box {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 3px;
      margin-right: 8px;
      vertical-align: middle;
    }

    .metrics-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .metric-card {
      background: linear-gradient(135deg, #d7f0ff, #e8f5ff);
      border-radius: 12px;
      padding: 18px;
      border-left: 4px solid var(--accent-blue);
    }

    .metric-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--deep-blue);
    }

    .timeline-chart-container {
      background: var(--card-white);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 14px rgba(10,40,80,0.04);
      margin-bottom: 24px;
    }

    .timeline-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .timeline-controls label {
      font-size: 13px;
      font-weight: 600;
      color: var(--deep-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .timeline-controls select {
      padding: 8px 12px;
      border: 1px solid #d0dce6;
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .timeline-controls select:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(18, 62, 138, 0.1);
      background-color: #f8fbff;
    }

    .timeline-metrics {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .timeline-metric-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f0f4f8;
      border-radius: 6px;
      font-size: 12px;
    }

    .timeline-metric-badge .badge-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .timeline-chart-wrapper {
      position: relative;
      height: 350px;
      margin-top: 16px;
    }

    @media (max-width: 800px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }

      .filter-section {
        grid-template-columns: 1fr;
      }

      .timeline-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .timeline-controls select {
        width: 100%;
      }

      .timeline-chart-wrapper {
        height: 250px;
      }
    }

    .analytics-section {
      background: var(--card-white);
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 6px 14px rgba(10,40,80,0.04);
      margin-top: 20px;
    }

    .analytics-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .analytics-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .fullscreen-btn {
      padding: 8px 12px;
      background: var(--accent-blue);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(23, 74, 139, 0.2);
    }

    .fullscreen-btn:hover {
      background: var(--accent-blue-dark, #1a5a99);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(23, 74, 139, 0.3);
    }

    .analytics-fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--bg-color);
      z-index: 1000;
      padding: 20px;
      overflow: auto;
    }

    .analytics-fullscreen .analytics-section {
      height: calc(100vh - 40px);
      margin: 0;
    }

    .btn-apply-header {
      padding: 10px 20px;
      background: var(--accent-blue);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(23, 74, 139, 0.2);
    }

    .btn-apply-header:hover {
      background: var(--accent-blue-dark, #1a5a99);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(23, 74, 139, 0.3);
    }

    #analytics-results-container {
      min-height: 400px;
      overflow: auto;
    }

    .view-toggles {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .toggle-btn {
      padding: 10px 20px;
      border: 1px solid #d0dce6;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-pagination {
      padding: 8px 16px;
      border: 1px solid #d0dce6;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      margin: 0 5px;
    }

    .btn-pagination:hover {
      background: var(--accent-blue);
      color: white;
      border-color: var(--accent-blue);
    }

    .data-table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
    }

    .data-table th, .data-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    .data-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    .data-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .data-table tr:hover {
      background-color: #f5f5f5;
    }

    /* Analytics View Styles */
    .analytics-view-content {
      display: block;
    }

    /* Metrics Row */
    .metrics-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }

    .metric-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--deep-blue);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--accent-blue);
    }

    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
    }

    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--deep-blue);
      margin-bottom: 16px;
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
      margin-bottom: 16px;
    }

    /* Timeline filters */
    .timeline-filters {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .timeline-chart-wrapper {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
      height: 400px;
    }

    /* Lists */
    .customer-types-list, .routes-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .customer-types-list li, .routes-list li {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 12px;
      color: #666;
    }

    .customer-types-list li strong, .routes-list li strong {
      color: var(--deep-blue);
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Top header bar -->
    <header class="top-bar">
      <div class="top-inner">
        <div class="brand">
          <div class="id-info">
            <div>MANAGER ID: <strong>{{ user_id }}</strong></div>
            <div>{{ user_name }}</div>
            <div>STATUS: <strong>Active</strong></div>
          </div>
        </div>

        <div style="text-align: center; font-weight: 700; color: var(--deep-blue); font-size: 20px;">
          MANAGEMENT
          <div style="font-size: 12px; font-weight: 400; margin-top: 4px;">
            <a href="{{ url_for('analytics_page') }}" style="color: var(--accent-blue); text-decoration: none;">â†’ Advanced Analytics</a>
          </div>
        </div>

        <div class="route-info">
          <div><strong>BusMate System</strong></div>
          <div>Fleet Management Dashboard</div>
          <div style="margin-top: 4px; font-size: 11px;">{{ current_date }}</div>
        </div>

        <div class="header-controls">
          <button class="fullscreen-btn" id="pageFullscreenBtn" onclick="togglePageFullscreen()" title="Toggle Fullscreen">
            <i class="fas fa-expand"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Main content -->
    <main class="main-content">
      <!-- Dashboard View -->
      <section class="dashboard-wrap" id="dashboardView">
        <h1 class="page-title">Analytics Dashboard</h1>

        <!-- Timeline Chart Section -->
        <div class="timeline-chart-container">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div class="chart-title" style="margin-bottom: 0;">Revenue & Customer Growth Trends</div>
            <div class="timeline-controls" style="margin-bottom: 0;">
              <label>Time Period:</label>
              <select id="timelineGroupBy" onchange="updateTimelineFilters()">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly" selected>Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
          </div>

          <!-- Dynamic Timeline Filters -->
          <div id="timelineFilterSection" class="filter-section" style="display: none; margin-bottom: 16px; margin-top: -10px;">
            <!-- Daily Filters -->
            <div id="dailyFilters" style="display: none; grid-column: 1 / -1;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                <div class="filter-group">
                  <label>Start Date</label>
                  <input type="date" id="timelineDailyStart" onchange="updateTimelineChart()" />
                </div>
                <div class="filter-group">
                  <label>End Date</label>
                  <input type="date" id="timelineDailyEnd" onchange="updateTimelineChart()" />
                </div>
                <div class="filter-group">
                  <label>Year</label>
                  <select id="timelineDailyYear" onchange="updateTimelineChart()">
                    <option value="">All Years</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label>Month</label>
                  <select id="timelineDailyMonth" onchange="updateTimelineChart()">
                    <option value="">All Months</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Weekly Filters -->
            <div id="weeklyFilters" style="display: none; grid-column: 1 / -1;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                <div class="filter-group">
                  <label>Year</label>
                  <select id="timelineWeeklyYear" onchange="updateTimelineChart()">
                    <option value="">All Years</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label>Month</label>
                  <select id="timelineWeeklyMonth" onchange="updateTimelineChart()">
                    <option value="">All Months</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Monthly Filters -->
            <div id="monthlyFilters" style="display: none; grid-column: 1 / -1;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                <div class="filter-group">
                  <label>Start Year</label>
                  <input type="number" id="timelineMonthlyStartYear" min="2020" max="2099" onchange="updateTimelineChart()" />
                </div>
                <div class="filter-group">
                  <label>End Year</label>
                  <input type="number" id="timelineMonthlyEndYear" min="2020" max="2099" onchange="updateTimelineChart()" />
                </div>
              </div>
            </div>

            <!-- Quarterly Filters -->
            <div id="quarterlyFilters" style="display: none; grid-column: 1 / -1;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                <div class="filter-group">
                  <label>Start Year</label>
                  <input type="number" id="timelineQuarterlyStartYear" min="2020" max="2099" onchange="updateTimelineChart()" />
                </div>
                <div class="filter-group">
                  <label>End Year</label>
                  <input type="number" id="timelineQuarterlyEndYear" min="2020" max="2099" onchange="updateTimelineChart()" />
                </div>
              </div>
            </div>

            <!-- Yearly Filters -->
            <div id="yearlyFilters" style="display: none; grid-column: 1 / -1;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                <div class="filter-group">
                  <label>Start Year</label>
                  <input type="number" id="timelineYearlyStart" min="2020" max="2099" onchange="updateTimelineChart()" />
                </div>
                <div class="filter-group">
                  <label>End Year</label>
                  <input type="number" id="timelineYearlyEnd" min="2020" max="2099" onchange="updateTimelineChart()" />
                </div>
              </div>
            </div>
          </div>

          <div class="timeline-metrics">
            <div class="timeline-metric-badge">
              <div class="badge-color" style="background-color: #174a8b;"></div>
              <span>Revenue</span>
            </div>
            <div class="timeline-metric-badge">
              <div class="badge-color" style="background-color: #2469a8;"></div>
              <span>Customers</span>
            </div>
          </div>

          <div class="timeline-chart-wrapper">
            <canvas id="timelineChart"></canvas>
          </div>
        </div>

        <!-- Metrics Row -->
        <div class="metrics-row">
          <div class="metric-card">
            <div class="metric-label">Total Customers</div>
            <div class="metric-value" id="totalCustomers">0</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Total Revenue</div>
            <div class="metric-value" id="totalRevenue">$0</div>
          </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
          <div class="filter-group">
            <label>From Date</label>
            <input type="date" id="filterFromDate" />
          </div>
          <div class="filter-group">
            <label>To Date</label>
            <input type="date" id="filterToDate" />
          </div>
          <div class="filter-group">
            <label>Bus Number</label>
            <select id="filterBus">
              <option value="">All Buses</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Route</label>
            <select id="filterRoute">
              <option value="">All Routes</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Customer Type</label>
            <select id="filterCustomerType">
              <option value="">All Types</option>
            </select>
          </div>
          <div class="filter-buttons">
            <button class="btn-apply" onclick="applyFilters()">Apply Filters</button>
            <button class="btn-reset" onclick="resetFilters()">Reset</button>
          </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
          <!-- Customer Types Pie Chart -->
          <div class="chart-container">
            <div class="chart-title">Customer Types Distribution</div>
            <div class="chart-wrapper">
              <canvas id="customerTypeChart"></canvas>
            </div>
            <ul class="customer-types-list" id="customerTypesList"></ul>
          </div>

          <!-- Routes Bar Chart -->
          <div class="chart-container">
            <div class="chart-title">Top Locations (From & To)</div>
            <div class="chart-wrapper">
              <canvas id="routesChart"></canvas>
            </div>
            <ul class="routes-list" id="routesList"></ul>
          </div>
        </div>
      </section>

      <!-- Manage View -->
      <section class="dashboard-wrap" id="manageView" style="display: none;">
        <h1 class="page-title">Management System</h1>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
          <!-- User Management Section -->
          <div class="chart-container">
            <div class="chart-title">User Management</div>
            <div style="padding: 16px;">
              <button class="btn primary" onclick="openUserModal()" style="width: 100%; margin-bottom: 12px;">Add New User</button>
              <input type="text" id="userSearchInput" placeholder="Search by User ID..." style="width: 100%; padding: 10px 12px; border: 1px solid #d0dce6; border-radius: 8px; margin-bottom: 12px; font-size: 13px;" onkeyup="filterUsers()">
              <div id="usersList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
          </div>

          <!-- Bus Management Section -->
          <div class="chart-container">
            <div class="chart-title">Bus Management</div>
            <div style="padding: 16px;">
              <button class="btn primary" onclick="openBusModal()" style="width: 100%; margin-bottom: 12px;">Add New Bus</button>
              <input type="text" id="busSearchInput" placeholder="Search by Bus ID..." style="width: 100%; padding: 10px 12px; border: 1px solid #d0dce6; border-radius: 8px; margin-bottom: 12px; font-size: 13px;" onkeyup="filterBuses()">
              <div id="busList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Analytics View -->
      <section class="dashboard-wrap" id="analyticsView" style="display: none;">
        <h1 class="page-title">Advanced Analytics & OLAP</h1>

        <div class="filters-section">
          <div class="filter-group">
            <label for="analytics_from_date">From Date</label>
            <input type="date" id="analytics_from_date" value="{{ current_date }}">
          </div>
          <div class="filter-group">
            <label for="analytics_to_date">To Date</label>
            <input type="date" id="analytics_to_date" value="{{ current_date }}">
          </div>
          <div class="filter-group">
            <label for="analytics_bus_filter">Bus</label>
            <select id="analytics_bus_filter">
              <option value="">All Buses</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="analytics_customer_filter">Customer Type</label>
            <select id="analytics_customer_filter">
              <option value="">All Types</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="analytics_user_filter">User</label>
            <select id="analytics_user_filter">
              <option value="">All Users</option>
            </select>
          </div>
          <div class="filter-buttons" style="grid-column: span 2; display: flex; justify-content: center;">
            <button class="btn-reset" onclick="resetAnalyticsFilters()">Reset</button>
          </div>
        </div>

        <div class="analytics-section">
          <div class="analytics-header">
            <div class="view-toggles">
              <button class="toggle-btn active" id="overview-view" onclick="setAnalyticsView('overview')">Overview</button>
              <!-- <button class="toggle-btn" id="timeline-view" onclick="setAnalyticsView('timeline')">Timeline</button> -->
              <button class="toggle-btn" id="customers-view" onclick="setAnalyticsView('customers')">Customers</button>
              <button class="toggle-btn" id="locations-view" onclick="setAnalyticsView('locations')">Locations</button>
              <button class="toggle-btn" id="data-view" onclick="setAnalyticsView('data')">Data Table</button>
            </div>
            <button class="btn-apply-header" onclick="loadAnalyticsData()">Apply Filters</button>
          </div>

          <div id="analytics-results-container">
            <div class="loading" style="text-align: center; padding: 40px; color: #666;">Loading analytics data...</div>
            <!-- Overview View -->
            <div id="analytics-overview-content" class="analytics-view-content">
              <div class="metrics-row">
                <div class="metric-card">
                  <div class="metric-label">Total Customers</div>
                  <div class="metric-value" id="analytics-totalCustomers">0</div>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Total Revenue</div>
                  <div class="metric-value" id="analytics-totalRevenue">$0</div>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Average Transaction</div>
                  <div class="metric-value" id="analytics-avgTransaction">$0</div>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Top Customer Type</div>
                  <div class="metric-value" id="analytics-topCustomerType">N/A</div>
                </div>
              </div>

              <div class="charts-grid">
                <div class="chart-container">
                  <div class="chart-title">Revenue & Customer Growth Trends</div>

                  <div class="timeline-filters" style="margin-bottom: 16px;">
                    <div class="filter-group">
                      <label>Year</label>
                      <select id="analytics-overviewYear" onchange="createAnalyticsOverviewChart()">
                        <option value="">All Years</option>
                        <option value="2020">2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                      </select>
                    </div>
                    <div class="filter-group">
                      <label>Month</label>
                      <select id="analytics-overviewMonth" onchange="createAnalyticsOverviewChart()">
                        <option value="">All Months</option>
                        <option value="January">January</option>
                        <option value="February">February</option>
                        <option value="March">March</option>
                        <option value="April">April</option>
                        <option value="May">May</option>
                        <option value="June">June</option>
                        <option value="July">July</option>
                        <option value="August">August</option>
                        <option value="September">September</option>
                        <option value="October">October</option>
                        <option value="November">November</option>
                        <option value="December">December</option>
                      </select>
                    </div>
                    <div class="filter-group">
                      <label>Group By</label>
                      <select id="analytics-overviewGroupBy" onchange="createAnalyticsOverviewChart()">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly" selected>Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="yearly">Yearly</option>
                      </select>
                    </div>
                  </div>

                  <div class="timeline-metrics" style="margin-bottom: 16px;">
                    <div class="timeline-metric-badge">
                      <div class="badge-color" style="background-color: #1e5fa0;"></div>
                      <span>Revenue</span>
                    </div>
                    <div class="timeline-metric-badge">
                      <div class="badge-color" style="background-color: #27a745;"></div>
                      <span>Customers</span>
                    </div>
                  </div>

                  <div class="chart-wrapper">
                    <canvas id="analytics-overviewChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- Timeline View -->
            <div id="analytics-timeline-content" class="analytics-view-content" style="display: none;">
              <div class="timeline-filters">
                <div class="filter-group">
                  <label>Group By</label>
                  <select id="analytics-timelineGroupBy" onchange="updateAnalyticsTimelineChart()">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly" selected>Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="yearly">Yearly</option>
                  </select>
                </div>
              </div>

              <div class="timeline-chart-wrapper">
                <canvas id="analytics-timelineChart"></canvas>
              </div>
            </div>

            <!-- Customers View -->
            <div id="analytics-customers-content" class="analytics-view-content" style="display: none;">
              <div class="charts-grid">
                <div class="chart-container">
                  <div class="chart-title">Revenue by Customer Type</div>
                  <div class="chart-wrapper">
                    <canvas id="analytics-customerTypeChart"></canvas>
                  </div>
                  <ul class="customer-types-list" id="analytics-customerTypesList"></ul>
                </div>
              </div>
            </div>

            <!-- Locations View -->
            <div id="analytics-locations-content" class="analytics-view-content" style="display: none;">
              <div class="charts-grid">
                <div class="chart-container">
                  <div class="chart-title">Top Locations (From & To)</div>
                  <div class="chart-wrapper">
                    <canvas id="analytics-locationsChart"></canvas>
                  </div>
                  <ul class="routes-list" id="analytics-locationsList"></ul>
                </div>
              </div>
            </div>

            <!-- Data Table View -->
            <div id="analytics-data-content" class="analytics-view-content" style="display: none;">
              <!-- Data Table Filters -->
              <div class="data-table-filters" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                <div class="filter-group">
                  <label for="data-table-search">Search:</label>
                  <input type="text" id="data-table-search" placeholder="Search transactions..." style="width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="filter-group">
                  <label for="data-table-limit">Show:</label>
                  <select id="data-table-limit" onchange="changeAnalyticsDataLimit()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="50">50</option>
                    <option value="100" selected>100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                  </select>
                  <span style="margin-left: 5px;">entries</span>
                </div>
                <div class="filter-buttons">
                  <button class="btn-apply" onclick="applyDataTableFilters()">Apply Filters</button>
                  <button class="btn-reset" onclick="resetDataTableFilters()">Reset</button>
                </div>
              </div>

              <div id="analytics-data-table-container">
                <div class="loading">Loading data...</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    <!-- Bottom action bar -->
    <nav class="bottom-nav">
      <div class="nav-inner">
        <div class="nav-left">
          <button class="btn primary" onclick="window.location.href='/logout'">Log-out</button>
        </div>
        <div style="display: flex; gap: 12px; margin: 0 auto;">
          <button class="view-button active" onclick="switchView('dashboard')">Dashboard</button>
          <button class="view-button" onclick="switchView('manage')">Manage</button>
          <button class="view-button" onclick="switchView('analytics')">Analytics</button>
        </div>
        <div class="nav-right">
          <button class="btn primary" onclick="exportDashboard()">Export Data</button>
        </div>
      </div>
    </nav>

    <!-- Bottom bar for fullscreen mode -->
    <footer class="bottom-bar">
      <button class="exit-fullscreen-btn" onclick="togglePageFullscreen()" title="Exit Fullscreen">
        <i class="fas fa-compress"></i>
        Exit Fullscreen
      </button>
    </footer>

    <!-- Toast -->
    <div id="toast" class="toast toast-info"></div>

    <!-- User Profile Modal -->
    <div id="userProfileModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1300; align-items: center; justify-content: center; flex-direction: column;">
      <div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <h2 style="margin: 0 0 16px 0; color: var(--deep-blue);">User Profile</h2>
        <div id="userProfileContent" style="margin-bottom: 20px; font-size: 13px;">
          <!-- User details will be populated here -->
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button class="btn primary" onclick="openEditUserModal()" style="width: 100%; margin: 0; padding: 10px; background: #27a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Edit</button>
          <button class="btn" onclick="deleteUserAction()" style="width: 100%; margin: 0; padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Delete</button>
          <button class="btn" onclick="openBusAssignModal()" style="width: 100%; grid-column: 1/-1; margin: 0; padding: 10px; background: #f39c12; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Assign to Bus</button>
        </div>
        <button onclick="closeUserProfileModal()" style="width: 100%; margin-top: 10px; padding: 10px; border: 1px solid #d0dce6; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
      </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1300; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <h2 style="margin: 0 0 16px 0; color: var(--deep-blue);">Edit User</h2>
        <div style="margin-bottom: 12px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: var(--deep-blue);">User ID</label>
          <input type="text" id="editUserID" readonly style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; background: #f5f5f5; font-size: 13px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 12px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: var(--deep-blue);">First Name</label>
          <input type="text" id="editUserFN" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 12px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: var(--deep-blue);">Last Name</label>
          <input type="text" id="editUserLN" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 12px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: var(--deep-blue);">License</label>
          <input type="text" id="editUserLicense" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 12px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: var(--deep-blue);">Phone</label>
          <input type="text" id="editUserPhone" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 12px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: var(--deep-blue);">Email</label>
          <input type="email" id="editUserEmail" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: var(--deep-blue);">User Type</label>
          <select id="editUserType" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px; box-sizing: border-box;">
            <option value="driver">Driver</option>
            <option value="conductor">Conductor</option>
            <option value="bus_worker">Bus Worker</option>
            <option value="manager">Manager</option>
          </select>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button class="btn primary" onclick="confirmEditUser()" style="width: 100%; margin: 0; padding: 10px; background: #27a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Save</button>
          <button class="btn" onclick="closeEditUserModal()" style="width: 100%; margin: 0; padding: 10px; background: #ccc; color: black; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Bus Assignment Modal -->
    <div id="busAssignModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1300; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <h2 style="margin: 0 0 16px 0; color: var(--deep-blue);">Assign User to Bus</h2>
        <div style="margin-bottom: 16px; font-size: 12px; color: #666;">Assign this user to buses. A bus can have multiple users.</div>
        <div id="busAssignmentList" style="max-height: 300px; overflow-y: auto; margin-bottom: 16px;"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button class="btn primary" onclick="confirmBusAssignment()" style="width: 100%; margin: 0;">Save</button>
          <button class="btn" onclick="document.getElementById('busAssignModal').style.display='none'" style="width: 100%; margin: 0; background: #ccc; color: black;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1300; align-items: center; justify-content: center; flex-direction: column;">
      <div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <h2 style="margin: 0 0 16px 0; color: var(--deep-blue);" id="confirmTitle">Confirm Action</h2>
        <p style="margin: 0 0 20px 0; color: #333; font-size: 13px;" id="confirmMessage">Are you sure?</p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button id="confirmBtn" class="btn primary" onclick="executeConfirmedAction()" style="width: 100%; margin: 0; padding: 10px; background: #1e5fa0; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Confirm</button>
          <button class="btn" onclick="document.getElementById('confirmModal').style.display='none'" style="width: 100%; margin: 0; padding: 10px; background: #ccc; color: black; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Bus Profile Modal -->
    <div id="busProfileModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1300; align-items: center; justify-content: center; flex-direction: column;">
      <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <h2 style="margin: 0 0 16px 0; color: var(--deep-blue);">Bus Profile</h2>
        <div id="busProfileContent" style="margin-bottom: 20px; font-size: 13px;">
          <!-- Bus details will be populated here -->
        </div>
        <div style="margin-bottom: 16px;">
          <div style="font-weight: 600; color: var(--deep-blue); margin-bottom: 8px;">Assigned Users:</div>
          <div id="busAssignedUsers" style="background: #f5f5f5; padding: 12px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
            Loading...
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button class="btn primary" onclick="quickEditBus(currentBus ? currentBus.busSID : '')" style="width: 100%; margin: 0; padding: 10px; background: #27a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Edit</button>
          <button class="btn" onclick="quickDeleteBus(currentBus ? currentBus.busSID : '')" style="width: 100%; margin: 0; padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Delete</button>
        </div>
        <button onclick="closeBusProfileModal()" style="width: 100%; margin-top: 10px; padding: 10px; border: 1px solid #d0dce6; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
      </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1300; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <h2 style="margin: 0 0 16px 0; color: var(--deep-blue);">Add New User</h2>
        <form id="addUserForm" style="display: grid; gap: 12px;">
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--deep-blue); margin-bottom: 4px;">User ID *</label>
            <input type="text" id="addUserID" required style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px;">
          </div>
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--deep-blue); margin-bottom: 4px;">User Type</label>
            <select id="addUserType" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px;">
              <option value="bus_worker">Bus Worker</option>
              <option value="driver">Driver</option>
              <option value="conductor">Conductor</option>
              <option value="manager">Manager</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--deep-blue); margin-bottom: 4px;">First Name</label>
            <input type="text" id="addUserFN" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px;">
          </div>
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--deep-blue); margin-bottom: 4px;">Last Name</label>
            <input type="text" id="addUserLN" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px;">
          </div>
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--deep-blue); margin-bottom: 4px;">License</label>
            <input type="text" id="addUserLicense" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px;">
          </div>
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--deep-blue); margin-bottom: 4px;">Phone</label>
            <input type="text" id="addUserPhone" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px;">
          </div>
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--deep-blue); margin-bottom: 4px;">Email</label>
            <input type="email" id="addUserEmail" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px;">
          </div>
        </form>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
          <button class="btn primary" onclick="confirmAddUser()" style="width: 100%; margin: 0; padding: 10px; background: #1e5fa0; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Add User</button>
          <button class="btn" onclick="closeAddUserModal()" style="width: 100%; margin: 0; padding: 10px; background: #ccc; color: black; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Add Bus Modal -->
    <div id="addBusModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1300; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <h2 style="margin: 0 0 16px 0; color: var(--deep-blue);">Add New Bus</h2>
        <form id="addBusForm" style="display: grid; gap: 12px;">
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--deep-blue); margin-bottom: 4px;">Bus ID *</label>
            <input type="text" id="addBusID" required style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px;">
          </div>
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--deep-blue); margin-bottom: 4px;">License Plate *</label>
            <input type="text" id="addBusLicense" required style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px;">
          </div>
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--deep-blue); margin-bottom: 4px;">Bus Type</label>
            <select id="addBusType" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px;">
              <option value="coach">Coach</option>
              <option value="mini">Mini</option>
              <option value="double-decker">Double Decker</option>
              <option value="shuttle">Shuttle</option>
            </select>
          </div>
        </form>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
          <button class="btn primary" onclick="confirmAddBus()" style="width: 100%; margin: 0; padding: 10px; background: #1e5fa0; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Add Bus</button>
          <button class="btn" onclick="closeAddBusModal()" style="width: 100%; margin: 0; padding: 10px; background: #ccc; color: black; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Edit Bus Modal -->
    <div id="editBusModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1300; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <h2 style="margin: 0 0 16px 0; color: var(--deep-blue);">Edit Bus</h2>
        <form id="editBusForm" style="display: grid; gap: 12px;">
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--deep-blue); margin-bottom: 4px;">Bus ID</label>
            <input type="text" id="editBusID" readonly style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px; background: #f5f5f5;">
          </div>
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--deep-blue); margin-bottom: 4px;">License Plate</label>
            <input type="text" id="editBusLicense" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px;">
          </div>
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--deep-blue); margin-bottom: 4px;">Bus Type</label>
            <select id="editBusType" style="width: 100%; padding: 8px; border: 1px solid #d0dce6; border-radius: 6px; font-size: 13px;">
              <option value="coach">Coach</option>
              <option value="mini">Mini</option>
              <option value="double-decker">Double Decker</option>
              <option value="shuttle">Shuttle</option>
            </select>
          </div>
        </form>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
          <button class="btn primary" onclick="confirmEditBus()" style="width: 100%; margin: 0; padding: 10px; background: #27a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Update Bus</button>
          <button class="btn" onclick="closeEditBusModal()" style="width: 100%; margin: 0; padding: 10px; background: #ccc; color: black; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    let customerTypeChart, routesChart, timelineChart;
    let currentFilters = {
      fromDate: '',
      toDate: '',
      bus: '',
      route: '',
      customerType: ''
    };

    // State variables for management and confirmation
    let allUsers = [];
    let allBuses = [];
    let currentUser = null;
    let currentBus = null;
    let selectedBuses = [];
    let pendingAction = null;

    // Analytics variables
    let analyticsData = [];
    let currentAnalyticsView = 'table';

    function switchView(view) {
      // Hide all views
      document.getElementById('dashboardView').style.display = 'none';
      document.getElementById('manageView').style.display = 'none';
      document.getElementById('analyticsView').style.display = 'none';
      
      // Remove active class from all buttons
      document.querySelectorAll('.view-button').forEach(btn => btn.classList.remove('active'));
      
      // Show selected view and mark button as active
      if (view === 'dashboard') {
        document.getElementById('dashboardView').style.display = 'block';
        event.target.classList.add('active');
      } else if (view === 'manage') {
        document.getElementById('manageView').style.display = 'block';
        event.target.classList.add('active');
        loadManagementData();
      } else if (view === 'analytics') {
        document.getElementById('analyticsView').style.display = 'block';
        event.target.classList.add('active');
        setAnalyticsView('overview');
        loadAnalyticsData();
      }
    }

    function loadManagementData() {
      console.log('loadManagementData() called');
      
      // Load users
      fetch('/api/manager/users')
        .then(r => {
          console.log('Users API response status:', r.status);
          if (!r.ok) {
            console.error('Users API returned status:', r.status);
            return r.text().then(text => {
              console.error('Response text:', text);
              throw new Error(`HTTP ${r.status}`);
            });
          }
          return r.json();
        })
        .then(data => {
          console.log('Users data:', data);
          allUsers = data.users || [];
          console.log('Loaded users:', allUsers);
          console.log('Number of users:', allUsers.length);
          renderUsersList();
        })
        .catch(err => {
          console.error('Error loading users:', err);
          showToast('Failed to load users: ' + err.message);
        });
      
      // Load buses
      fetch('/api/manager/buses')
        .then(r => {
          console.log('Buses API response status:', r.status);
          if (!r.ok) {
            console.error('Buses API returned status:', r.status);
            return r.text().then(text => {
              console.error('Response text:', text);
              throw new Error(`HTTP ${r.status}`);
            });
          }
          return r.json();
        })
        .then(data => {
          console.log('Buses data:', data);
          allBuses = data.buses || [];
          console.log('Loaded buses:', allBuses);
          console.log('Number of buses:', allBuses.length);
          renderBusesList();
        })
        .catch(err => {
          console.error('Error loading buses:', err);
          showToast('Failed to load buses: ' + err.message);
        });
    }

    function renderUsersList() {
      const usersList = document.getElementById('usersList');
      const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
      const filtered = allUsers.filter(u => u.userID.toLowerCase().includes(searchTerm));
      
      if (filtered.length > 0) {
        const html = filtered.map(user => `
          <div style="padding: 12px; border-bottom: 1px solid #e8eef5; font-size: 12px; display: flex; justify-content: space-between; align-items: center; gap: 8px;">
            <div style="flex: 1; cursor: pointer;">
              <div style="font-weight: 600; color: var(--deep-blue);">${user.userID}</div>
              <div style="color: #666; font-size: 11px;">Type: ${user.userType}</div>
            </div>
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              <button onclick="viewUserProfile(${user.userSID})" style="padding: 6px 10px; background: #1e5fa0; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; white-space: nowrap;">Profile</button>
              <button onclick="quickEditUser(${user.userSID})" style="padding: 6px 10px; background: #27a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; white-space: nowrap;">Edit</button>
              <button onclick="quickDeleteUser(${user.userSID})" style="padding: 6px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; white-space: nowrap;">Delete</button>
            </div>
          </div>
        `).join('');
        usersList.innerHTML = html;
      } else {
        usersList.innerHTML = '<div style="padding: 8px; color: #999;">No users found</div>';
      }
    }

    function quickEditUser(userSID) {
      currentUser = allUsers.find(u => u.userSID === userSID);
      if (!currentUser) {
        showToast('User not found');
        return;
      }
      openEditUserModal();
    }

    function quickDeleteUser(userSID) {
      currentUser = allUsers.find(u => u.userSID === userSID);
      if (!currentUser) {
        showToast('User not found');
        return;
      }
      deleteUserAction();
    }

    // Bus Management Functions
    function viewBusProfile(busSID) {
      currentBus = allBuses.find(b => b.busSID === busSID);
      if (!currentBus) {
        showToast('Bus not found');
        return;
      }
      
      document.getElementById('busProfileContent').innerHTML = `
        <div style="margin-bottom: 12px;">
          <div style="color: #999; font-size: 11px; text-transform: uppercase;">Bus ID</div>
          <div style="font-weight: 600; font-size: 14px; color: var(--deep-blue);">${currentBus.busID}</div>
        </div>
        <div style="margin-bottom: 12px;">
          <div style="color: #999; font-size: 11px; text-transform: uppercase;">License Plate</div>
          <div style="font-weight: 600; font-size: 14px; color: var(--deep-blue);">${currentBus.busLicense}</div>
        </div>
        <div>
          <div style="color: #999; font-size: 11px; text-transform: uppercase;">Bus Type</div>
          <div style="font-weight: 600; font-size: 14px; color: var(--deep-blue);">${currentBus.busType}</div>
        </div>
      `;
      
      // Load assigned users
      fetch(`/api/manager/bus-assigned-users?busSID=${currentBus.busSID}`)
        .then(r => r.json())
        .then(data => {
          const usersList = document.getElementById('busAssignedUsers');
          if (data.users && data.users.length > 0) {
            const html = data.users.map(user => `
              <div style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 12px;">
                <div style="font-weight: 600; color: var(--deep-blue);">${user.userID}</div>
                <div style="color: #666; font-size: 11px;">Type: ${user.userType}</div>
              </div>
            `).join('');
            usersList.innerHTML = html;
          } else {
            usersList.innerHTML = '<div style="color: #999; text-align: center;">No users assigned</div>';
          }
        })
        .catch(err => {
          console.error('Error loading bus users:', err);
          document.getElementById('busAssignedUsers').innerHTML = '<div style="color: #999; text-align: center;">Error loading users</div>';
        });
      
      const modal = document.getElementById('busProfileModal');
      modal.style.display = 'flex';
    }

    function closeBusProfileModal() {
      document.getElementById('busProfileModal').style.display = 'none';
    }

    function quickEditBus(busSID) {
      currentBus = allBuses.find(b => b.busSID === busSID);
      if (!currentBus) {
        showToast('Bus not found');
        return;
      }
      document.getElementById('busProfileModal').style.display = 'none';
      
      document.getElementById('confirmTitle').textContent = 'Edit Bus';
      document.getElementById('confirmMessage').textContent = `Edit bus "${currentBus.busID}"? (Feature coming soon)`;
      document.getElementById('confirmBtn').textContent = 'OK';
      document.getElementById('confirmBtn').onclick = () => {
        document.getElementById('confirmModal').style.display = 'none';
        showToast('Bus editing coming soon');
      };
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function quickDeleteBus(busSID) {
      currentBus = allBuses.find(b => b.busSID === busSID);
      if (!currentBus) {
        showToast('Bus not found');
        return;
      }
      document.getElementById('busProfileModal').style.display = 'none';
      
      document.getElementById('confirmTitle').textContent = 'Confirm Delete Bus';
      document.getElementById('confirmMessage').textContent = `Delete bus "${currentBus.busID}"? This action cannot be undone.`;
      document.getElementById('confirmBtn').textContent = 'Delete';
      document.getElementById('confirmBtn').onclick = () => {
        fetch('/api/manager/delete-bus', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ busSID: currentBus.busSID })
        })
        .then(r => r.json())
        .then(data => {
          document.getElementById('confirmModal').style.display = 'none';
          if (data.success) {
            showToast('Bus deleted successfully');
            loadManagementData();
          } else {
            showToast('Failed to delete bus');
          }
        })
        .catch(err => {
          console.error('Error:', err);
          showToast('Error deleting bus');
          document.getElementById('confirmModal').style.display = 'none';
        });
      };
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function renderBusesList() {
      const busList = document.getElementById('busList');
      const searchTerm = document.getElementById('busSearchInput').value.toLowerCase();
      const filtered = allBuses.filter(b => b.busID.toLowerCase().includes(searchTerm));
      
      if (filtered.length > 0) {
        const html = filtered.map(bus => `
          <div style="padding: 12px; border-bottom: 1px solid #e8eef5; font-size: 12px; display: flex; justify-content: space-between; align-items: center; gap: 8px;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--deep-blue);">Bus ${bus.busID}</div>
              <div style="color: #666; font-size: 11px;">License: ${bus.busLicense} | Type: ${bus.busType}</div>
            </div>
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              <button onclick="viewBusProfile(${bus.busSID})" style="padding: 6px 10px; background: #1e5fa0; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; white-space: nowrap;">Profile</button>
              <button onclick="quickEditBus(${bus.busSID})" style="padding: 6px 10px; background: #27a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; white-space: nowrap;">Edit</button>
              <button onclick="quickDeleteBus(${bus.busSID})" style="padding: 6px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; white-space: nowrap;">Delete</button>
            </div>
          </div>
        `).join('');
        busList.innerHTML = html;
      } else {
        busList.innerHTML = '<div style="padding: 8px; color: #999;">No buses found</div>';
      }
    }

    function filterUsers() {
      renderUsersList();
    }

    function filterBuses() {
      renderBusesList();
    }

    function viewUserProfile(userSID) {
      currentUser = allUsers.find(u => u.userSID === userSID);
      if (!currentUser) {
        showToast('User not found');
        return;
      }
      
      let profileHTML = `
        <div style="margin-bottom: 12px;">
          <div style="color: #999; font-size: 11px; text-transform: uppercase;">User ID</div>
          <div style="font-weight: 600; font-size: 14px; color: var(--deep-blue);">${currentUser.userID}</div>
        </div>
        <div style="margin-bottom: 12px;">
          <div style="color: #999; font-size: 11px; text-transform: uppercase;">Name</div>
          <div style="font-weight: 600; font-size: 14px; color: var(--deep-blue);">${currentUser.userFN || ''} ${currentUser.userLN || ''}</div>
        </div>
        <div style="margin-bottom: 12px;">
          <div style="color: #999; font-size: 11px; text-transform: uppercase;">User Type</div>
          <div style="font-weight: 600; font-size: 14px; color: var(--deep-blue);">${currentUser.userType}</div>
        </div>
        <div style="margin-bottom: 12px;">
          <div style="color: #999; font-size: 11px; text-transform: uppercase;">License</div>
          <div style="font-weight: 600; font-size: 14px; color: var(--deep-blue);">${currentUser.userLicense || 'N/A'}</div>
        </div>
        <div style="margin-bottom: 12px;">
          <div style="color: #999; font-size: 11px; text-transform: uppercase;">Phone</div>
          <div style="font-weight: 600; font-size: 14px; color: var(--deep-blue);">${currentUser.userPhone || 'N/A'}</div>
        </div>
        <div>
          <div style="color: #999; font-size: 11px; text-transform: uppercase;">Email</div>
          <div style="font-weight: 600; font-size: 14px; color: var(--deep-blue);">${currentUser.userEmail || 'N/A'}</div>
        </div>
      `;
      
      document.getElementById('userProfileContent').innerHTML = profileHTML;
      
      const modal = document.getElementById('userProfileModal');
      modal.style.display = 'flex';
    }

    function closeUserProfileModal() {
      document.getElementById('userProfileModal').style.display = 'none';
    }

    function openEditUserModal() {
      if (!currentUser) return;
      document.getElementById('editUserID').value = currentUser.userID;
      document.getElementById('editUserFN').value = currentUser.userFN || '';
      document.getElementById('editUserLN').value = currentUser.userLN || '';
      document.getElementById('editUserLicense').value = currentUser.userLicense || '';
      document.getElementById('editUserPhone').value = currentUser.userPhone || '';
      document.getElementById('editUserEmail').value = currentUser.userEmail || '';
      document.getElementById('editUserType').value = currentUser.userType;
      document.getElementById('userProfileModal').style.display = 'none';
      document.getElementById('editUserModal').style.display = 'flex';
    }

    function closeEditUserModal() {
      document.getElementById('editUserModal').style.display = 'none';
    }

    function confirmEditUser() {
      if (!currentUser) return;
      
      const updatedData = {
        userSID: currentUser.userSID,
        userFN: document.getElementById('editUserFN').value,
        userLN: document.getElementById('editUserLN').value,
        userLicense: document.getElementById('editUserLicense').value,
        userPhone: document.getElementById('editUserPhone').value,
        userEmail: document.getElementById('editUserEmail').value,
        userType: document.getElementById('editUserType').value
      };
      
      document.getElementById('confirmTitle').textContent = 'Confirm Edit';
      document.getElementById('confirmMessage').textContent = `Update user "${currentUser.userID}"?`;
      document.getElementById('confirmBtn').onclick = () => executeEditUser(updatedData);
      document.getElementById('editUserModal').style.display = 'none';
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function executeEditUser(updatedData) {
      fetch('/api/manager/update-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedData)
      })
      .then(r => r.json())
      .then(data => {
        document.getElementById('confirmModal').style.display = 'none';
        if (data.success) {
          showToast('User updated successfully');
          loadManagementData();
          document.getElementById('userProfileModal').style.display = 'none';
        } else {
          showToast('Failed to update user: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(err => {
        console.error('Error updating user:', err);
        document.getElementById('confirmModal').style.display = 'none';
        showToast('Error updating user');
      });
    }

    function deleteUserAction() {
      if (!currentUser) return;
      
      document.getElementById('confirmTitle').textContent = 'Confirm Delete';
      document.getElementById('confirmMessage').textContent = `Delete user "${currentUser.userID}"? This action cannot be undone.`;
      document.getElementById('confirmBtn').onclick = executeDeleteUser;
      document.getElementById('userProfileModal').style.display = 'none';
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function executeDeleteUser() {
      fetch('/api/manager/delete-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userSID: currentUser.userSID })
      })
      .then(r => r.json())
      .then(data => {
        document.getElementById('confirmModal').style.display = 'none';
        if (data.success) {
          showToast('User deleted successfully');
          loadManagementData();
        } else {
          showToast('Failed to delete user');
        }
      })
      .catch(err => {
        console.error('Error:', err);
        showToast('Error deleting user');
        document.getElementById('confirmModal').style.display = 'none';
      });
    }

    // Bus Management Functions
    function viewBusProfile(busSID) {
      currentBus = allBuses.find(b => b.busSID === busSID);
      if (!currentBus) {
        showToast('Bus not found');
        return;
      }

      let profileHTML = `
        <div style="margin-bottom: 12px;">
          <div style="color: #999; font-size: 11px; text-transform: uppercase;">Bus ID</div>
          <div style="font-weight: 600; font-size: 14px; color: var(--deep-blue);">${currentBus.busID}</div>
        </div>
        <div style="margin-bottom: 12px;">
          <div style="color: #999; font-size: 11px; text-transform: uppercase;">License Plate</div>
          <div style="font-weight: 600; font-size: 14px; color: var(--deep-blue);">${currentBus.busLicense}</div>
        </div>
        <div>
          <div style="color: #999; font-size: 11px; text-transform: uppercase;">Bus Type</div>
          <div style="font-weight: 600; font-size: 14px; color: var(--deep-blue);">${currentBus.busType}</div>
        </div>
      `;

      document.getElementById('busProfileContent').innerHTML = profileHTML;

      // Load assigned users
      fetch(`/api/manager/bus-assigned-users?busSID=${busSID}`)
        .then(r => r.json())
        .then(data => {
          const usersDiv = document.getElementById('busAssignedUsers');
          if (data.users && data.users.length > 0) {
            const usersHTML = data.users.map(u => `<div style="padding: 4px 0; border-bottom: 1px solid #eee;">${u.userID} (${u.userType})</div>`).join('');
            usersDiv.innerHTML = usersHTML;
          } else {
            usersDiv.innerHTML = 'No users assigned to this bus.';
          }
        })
        .catch(err => {
          console.error('Error loading assigned users:', err);
          document.getElementById('busAssignedUsers').innerHTML = 'Error loading users.';
        });

      const modal = document.getElementById('busProfileModal');
      modal.style.display = 'flex';
    }

    function closeBusProfileModal() {
      document.getElementById('busProfileModal').style.display = 'none';
    }

    function quickEditBus(busSID) {
      currentBus = allBuses.find(b => b.busSID === busSID);
      if (!currentBus) {
        showToast('Bus not found');
        return;
      }

      document.getElementById('editBusID').value = currentBus.busID;
      document.getElementById('editBusLicense').value = currentBus.busLicense;
      document.getElementById('editBusType').value = currentBus.busType;
      document.getElementById('busProfileModal').style.display = 'none';
      document.getElementById('editBusModal').style.display = 'flex';
    }

    function closeEditBusModal() {
      document.getElementById('editBusModal').style.display = 'none';
    }

    function confirmEditBus() {
      if (!currentBus) return;

      const updatedData = {
        busSID: currentBus.busSID,
        busID: document.getElementById('editBusID').value.trim(),
        busLicense: document.getElementById('editBusLicense').value.trim(),
        busType: document.getElementById('editBusType').value
      };

      document.getElementById('confirmTitle').textContent = 'Confirm Edit';
      document.getElementById('confirmMessage').textContent = `Update bus "${currentBus.busID}"?`;
      document.getElementById('confirmBtn').onclick = () => executeEditBus(updatedData);
      document.getElementById('editBusModal').style.display = 'none';
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function executeEditBus(updatedData) {
      fetch('/api/manager/update-bus', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedData)
      })
      .then(r => r.json())
      .then(data => {
        document.getElementById('confirmModal').style.display = 'none';
        if (data.success) {
          showToast('Bus updated successfully');
          loadManagementData();
          document.getElementById('busProfileModal').style.display = 'none';
        } else {
          showToast('Failed to update bus: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(err => {
        console.error('Error updating bus:', err);
        document.getElementById('confirmModal').style.display = 'none';
        showToast('Error updating bus');
      });
    }

    function quickDeleteBus(busSID) {
      currentBus = allBuses.find(b => b.busSID === busSID);
      if (!currentBus) {
        showToast('Bus not found');
        return;
      }

      document.getElementById('confirmTitle').textContent = 'Confirm Delete';
      document.getElementById('confirmMessage').textContent = `Delete bus "${currentBus.busID}"? This action cannot be undone.`;
      document.getElementById('confirmBtn').onclick = executeDeleteBus;
      document.getElementById('busProfileModal').style.display = 'none';
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function executeDeleteBus() {
      fetch('/api/manager/delete-bus', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ busSID: currentBus.busSID })
      })
      .then(r => r.json())
      .then(data => {
        document.getElementById('confirmModal').style.display = 'none';
        if (data.success) {
          showToast('Bus deleted successfully');
          loadManagementData();
        } else {
          showToast('Failed to delete bus');
        }
      })
      .catch(err => {
        console.error('Error:', err);
        showToast('Error deleting bus');
        document.getElementById('confirmModal').style.display = 'none';
      });
    }

    function openBusAssignModal() {
      if (!currentUser) return;
      document.getElementById('userProfileModal').style.display = 'none';
      
      // Load current assignments and show buses
      fetch(`/api/manager/user-bus-assignments?userSID=${currentUser.userSID}`)
        .then(r => r.json())
        .then(data => {
          selectedBuses = data.assignments || [];
          renderBusAssignmentList();
          document.getElementById('busAssignModal').style.display = 'flex';
        })
        .catch(err => {
          console.error('Error loading assignments:', err);
          renderBusAssignmentList();
          document.getElementById('busAssignModal').style.display = 'flex';
        });
    }

    function renderBusAssignmentList() {
      const list = document.getElementById('busAssignmentList');
      const html = allBuses.map(bus => {
        const isAssigned = selectedBuses.includes(bus.busSID);
        return `
          <div style="padding: 10px; border-bottom: 1px solid #e8eef5; display: flex; align-items: center;">
            <input type="checkbox" id="bus_${bus.busSID}" ${isAssigned ? 'checked' : ''} onchange="toggleBusSelection(${bus.busSID})" style="margin-right: 10px; cursor: pointer;">
            <label for="bus_${bus.busSID}" style="flex: 1; cursor: pointer; font-size: 13px;">
              <div style="font-weight: 600; color: var(--deep-blue);">Bus ${bus.busID}</div>
              <div style="color: #666; font-size: 11px;">License: ${bus.busLicense}</div>
            </label>
          </div>
        `;
      }).join('');
      list.innerHTML = html || '<div style="padding: 10px; color: #999;">No buses available</div>';
    }

    function toggleBusSelection(busSID) {
      const index = selectedBuses.indexOf(busSID);
      if (index > -1) {
        selectedBuses.splice(index, 1);
      } else {
        selectedBuses.push(busSID);
      }
      console.log('Selected buses:', selectedBuses);
    }

    function confirmBusAssignment() {
      if (!currentUser) return;
      
      document.getElementById('confirmTitle').textContent = 'Confirm Assignment';
      document.getElementById('confirmMessage').textContent = `Assign user "${currentUser.userID}" to ${selectedBuses.length} bus(es)?`;
      document.getElementById('confirmBtn').onclick = executeBusAssignment;
      document.getElementById('busAssignModal').style.display = 'none';
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function executeBusAssignment() {
      fetch('/api/manager/assign-user-to-buses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userSID: currentUser.userSID, busSIDs: selectedBuses })
      })
      .then(r => r.json())
      .then(data => {
        document.getElementById('confirmModal').style.display = 'none';
        if (data.success) {
          showToast('Bus assignments updated successfully');
          loadManagementData();
        } else {
          showToast('Failed to update assignments');
        }
      })
      .catch(err => {
        console.error('Error:', err);
        showToast('Error updating assignments');
        document.getElementById('confirmModal').style.display = 'none';
      });
    }

    function executeConfirmedAction() {
      // This is handled by specific onclick handlers set in confirmation functions
    }

    function openUserModal() {
      document.getElementById('addUserForm').reset();
      document.getElementById('addUserModal').style.display = 'flex';
    }

    function closeAddUserModal() {
      document.getElementById('addUserModal').style.display = 'none';
    }

    function confirmAddUser() {
      const userData = {
        userID: document.getElementById('addUserID').value.trim(),
        userType: document.getElementById('addUserType').value,
        userFN: document.getElementById('addUserFN').value.trim(),
        userLN: document.getElementById('addUserLN').value.trim(),
        userLicense: document.getElementById('addUserLicense').value.trim(),
        userPhone: document.getElementById('addUserPhone').value.trim(),
        userEmail: document.getElementById('addUserEmail').value.trim()
      };

      if (!userData.userID) {
        showToast('User ID is required');
        return;
      }

      document.getElementById('confirmTitle').textContent = 'Confirm Add User';
      document.getElementById('confirmMessage').textContent = `Add new user "${userData.userID}"?`;
      document.getElementById('confirmBtn').onclick = () => executeAddUser(userData);
      document.getElementById('addUserModal').style.display = 'none';
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function executeAddUser(userData) {
      fetch('/api/manager/add-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      })
      .then(r => r.json())
      .then(data => {
        document.getElementById('confirmModal').style.display = 'none';
        if (data.success) {
          showToast('User added successfully');
          loadManagementData();
        } else {
          showToast('Failed to add user: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(err => {
        console.error('Error adding user:', err);
        document.getElementById('confirmModal').style.display = 'none';
        showToast('Error adding user');
      });
    }

    function openBusModal() {
      document.getElementById('addBusForm').reset();
      document.getElementById('addBusModal').style.display = 'flex';
    }

    function closeAddBusModal() {
      document.getElementById('addBusModal').style.display = 'none';
    }

    function confirmAddBus() {
      const busData = {
        busID: document.getElementById('addBusID').value.trim(),
        busLicense: document.getElementById('addBusLicense').value.trim(),
        busType: document.getElementById('addBusType').value
      };

      if (!busData.busID || !busData.busLicense) {
        showToast('Bus ID and License are required');
        return;
      }

      document.getElementById('confirmTitle').textContent = 'Confirm Add Bus';
      document.getElementById('confirmMessage').textContent = `Add new bus "${busData.busID}"?`;
      document.getElementById('confirmBtn').onclick = () => executeAddBus(busData);
      document.getElementById('addBusModal').style.display = 'none';
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function executeAddBus(busData) {
      fetch('/api/manager/add-bus', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(busData)
      })
      .then(r => r.json())
      .then(data => {
        document.getElementById('confirmModal').style.display = 'none';
        if (data.success) {
          showToast('Bus added successfully');
          loadManagementData();
        } else {
          showToast('Failed to add bus: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(err => {
        console.error('Error adding bus:', err);
        document.getElementById('confirmModal').style.display = 'none';
        showToast('Error adding bus');
      });
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast toast-' + type;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 5000); // Longer duration for error messages
    }

    function loadAnalyticsData() {
      console.log('loadAnalyticsData called');
      const container = document.getElementById('analytics-results-container');
      if (container) {
        const loading = container.querySelector('.loading');
        if (loading) loading.style.display = 'block';
      }

      // Build query parameters
      const params = new URLSearchParams();
      const fromDate = document.getElementById('analytics_from_date').value;
      const toDate = document.getElementById('analytics_to_date').value;
      const busId = document.getElementById('analytics_bus_filter').value;
      const customerType = document.getElementById('analytics_customer_filter').value;
      const userId = document.getElementById('analytics_user_filter').value;

      if (fromDate) params.append('from_date', fromDate);
      if (toDate) params.append('to_date', toDate);
      if (busId) params.append('bus_id', busId);
      if (customerType) params.append('customer_type', customerType);
      if (userId) params.append('user_id', userId);

      console.log('Fetching analytics data with params:', params.toString());

      // Load dashboard-style analytics data
      loadAnalyticsOverview(params);
    }

    function loadAnalyticsOverview(params) {
      // Load summary data
      fetch('/api/manager/dashboard-data?' + params.toString())
        .then(response => response.json())
        .then(data => {
          analyticsData = data;
          updateAnalyticsOverviewDisplay();
          updateAnalyticsCustomerChart();
          updateAnalyticsLocationsChart();

          // Load timeline data
          const groupBy = document.getElementById('analytics-timelineGroupBy').value;
          loadAnalyticsTimelineData(groupBy, params);

          // Load data table
          loadAnalyticsDataTable(params);

          const loading = document.querySelector('#analytics-results-container .loading');
          if (loading) loading.style.display = 'none';
        })
        .catch(error => {
          console.error('Error loading analytics data:', error);
          showToast('Failed to load analytics data');
          const loading = document.querySelector('#analytics-results-container .loading');
          if (loading) loading.style.display = 'none';
        });
    }

    function updateAnalyticsOverviewDisplay() {
      if (!analyticsData) return;

      document.getElementById('analytics-totalCustomers').textContent = analyticsData.totalCustomers || 0;
      document.getElementById('analytics-totalRevenue').textContent = '$' + (analyticsData.totalRevenue || 0).toFixed(2);

      const avgTransaction = analyticsData.totalTransactions > 0 ?
        (analyticsData.totalRevenue / analyticsData.totalTransactions).toFixed(2) : 0;
      document.getElementById('analytics-avgTransaction').textContent = '$' + avgTransaction;

      // Find top customer type
      let topType = 'N/A';
      let maxCount = 0;
      if (analyticsData.customerTypes) {
        analyticsData.customerTypes.forEach(type => {
          if (type.count > maxCount) {
            maxCount = type.count;
            topType = type.name;
          }
        });
      }
      document.getElementById('analytics-topCustomerType').textContent = topType;

      // Create overview chart
      createAnalyticsOverviewChart();
    }

    function createAnalyticsOverviewChart() {
      const ctx = document.getElementById('analytics-overviewChart');
      if (!ctx) return;

      // Destroy existing chart if it exists
      if (ctx.chart) {
        ctx.chart.destroy();
      }

      // Get timeline data for the overview chart (similar to dashboard)
      const year = document.getElementById('analytics-overviewYear').value;
      const month = document.getElementById('analytics-overviewMonth').value;
      const groupBy = document.getElementById('analytics-overviewGroupBy').value;
      const params = new URLSearchParams();
      params.append('group_by', groupBy);
      if (year) params.append('year', year);
      if (month) params.append('month', month);

      fetch('/api/manager/timeline-data?' + params.toString())
        .then(response => response.json())
        .then(data => {
          const labels = data.labels || [];
          const revenueData = data.revenue || [];
          const customerData = data.customers || [];

          // Revenue and Customer Growth Trends (dual axis line chart)
          const chartData = {
            labels: labels,
            datasets: [
              {
                label: 'Revenue ($)',
                data: revenueData,
                borderColor: '#1e5fa0',
                backgroundColor: 'rgba(30, 95, 160, 0.08)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointBackgroundColor: '#1e5fa0',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointHoverRadius: 7,
                yAxisID: 'y'
              },
              {
                label: 'Customer Count',
                data: customerData,
                borderColor: '#27a745',
                backgroundColor: 'rgba(39, 167, 69, 0.08)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointBackgroundColor: '#27a745',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointHoverRadius: 7,
                yAxisID: 'y1'
              }
            ]
          };

          ctx.chart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: 'index',
                intersect: false
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  labels: {
                    boxWidth: 12,
                    padding: 15,
                    font: {
                      size: 13,
                      weight: '600'
                    },
                    color: '#0d2b4d'
                  }
                }
              },
              scales: {
                y: {
                  type: 'linear',
                  display: true,
                  position: 'left',
                  title: {
                    display: true,
                    text: 'Revenue ($)',
                    font: { size: 12, weight: '600' },
                    color: '#1e5fa0'
                  },
                  ticks: {
                    color: '#1e5fa0',
                    font: { size: 11 },
                    callback: function(value) {
                      return '$' + value.toLocaleString();
                    }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                  }
                },
                y1: {
                  type: 'linear',
                  display: true,
                  position: 'right',
                  title: {
                    display: true,
                    text: 'Customer Count',
                    font: { size: 12, weight: '600' },
                    color: '#27a745'
                  },
                  ticks: {
                    color: '#27a745',
                    font: { size: 11 }
                  },
                  grid: {
                    drawOnChartArea: false
                  }
                },
                x: {
                  ticks: {
                    font: { size: 11 },
                    color: '#666'
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                  }
                }
              }
            }
          });
        })
        .catch(error => {
          console.error('Error loading timeline data for analytics overview:', error);
          // Fallback to simple bar chart if timeline data fails
          const revenue = analyticsData.totalRevenue || 0;
          const transactions = analyticsData.totalTransactions || 0;

          const fallbackData = {
            labels: ['Total Revenue'],
            datasets: [{
              label: 'Revenue ($)',
              data: [revenue],
              backgroundColor: ['#174a8b'],
              borderWidth: 1
            }]
          };

          ctx.chart = new Chart(ctx, {
            type: 'bar',
            data: fallbackData,
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                },
                title: {
                  display: true,
                  text: `Revenue Overview (${transactions.toLocaleString()} transactions)`,
                  font: { size: 14 }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Revenue ($)'
                  },
                  ticks: {
                    callback: function(value) {
                      return '$' + value.toLocaleString();
                    }
                  }
                }
              }
            }
          });
        });
    }

    function loadAnalyticsTimelineData(groupBy, params) {
      const timelineParams = new URLSearchParams(params);
      timelineParams.set('group_by', groupBy);

      fetch('/api/manager/timeline-data?' + timelineParams.toString())
        .then(response => response.json())
        .then(data => {
          createAnalyticsTimelineChart(data);
        })
        .catch(error => console.error('Error loading timeline data:', error));
    }

    function createAnalyticsTimelineChart(data) {
      const ctx = document.getElementById('analytics-timelineChart');
      if (!ctx) return;

      // Destroy existing chart if it exists
      if (ctx.chart) {
        ctx.chart.destroy();
      }

      const chartData = {
        labels: data.labels || [],
        datasets: [{
          label: 'Revenue',
          data: data.revenue || [],
          borderColor: '#174a8b',
          backgroundColor: 'rgba(23, 74, 139, 0.1)',
          yAxisID: 'y',
          tension: 0.4
        }, {
          label: 'Transactions',
          data: data.customers || [],
          borderColor: '#2469a8',
          backgroundColor: 'rgba(36, 105, 168, 0.1)',
          yAxisID: 'y1',
          tension: 0.4
        }]
      };

      ctx.chart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Revenue ($)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Transactions'
              },
              grid: {
                drawOnChartArea: false,
              },
            }
          }
        }
      });
    }

    function updateAnalyticsCustomerChart() {
      const ctx = document.getElementById('analytics-customerTypeChart');
      if (!ctx || !analyticsData.customerTypes) return;

      // Destroy existing chart if it exists
      if (ctx.chart) {
        ctx.chart.destroy();
      }

      const data = {
        labels: analyticsData.customerTypes.map(type => type.name),
        datasets: [{
          data: analyticsData.customerTypes.map(type => type.count),
          backgroundColor: [
            '#174a8b', '#2469a8', '#3d8dd9', '#5ba4e5', '#7bbbf1'
          ]
        }]
      };

      ctx.chart = new Chart(ctx, {
        type: 'pie',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'right'
            }
          }
        }
      });

      // Update list
      const list = document.getElementById('analytics-customerTypesList');
      list.innerHTML = analyticsData.customerTypes.map(type =>
        `<li><span>${type.name}</span><strong>${type.count}</strong></li>`
      ).join('');
    }

    function updateAnalyticsLocationsChart() {
      const ctx = document.getElementById('analytics-locationsChart');
      if (!ctx || !analyticsData.topRoutes) return;

      // Destroy existing chart if it exists
      if (ctx.chart) {
        ctx.chart.destroy();
      }

      const data = {
        labels: analyticsData.topRoutes.slice(0, 10).map(route => route.location),
        datasets: [{
          label: 'From',
          data: analyticsData.topRoutes.slice(0, 10).map(route => route.from_count),
          backgroundColor: '#174a8b'
        }, {
          label: 'To',
          data: analyticsData.topRoutes.slice(0, 10).map(route => route.to_count),
          backgroundColor: '#2469a8'
        }]
      };

      ctx.chart = new Chart(ctx, {
        type: 'bar',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            x: {
              stacked: false,
            },
            y: {
              stacked: false,
              beginAtZero: true,
              title: {
                display: true,
                text: 'Count'
              }
            }
          }
        }
      });

      // Update list
      const list = document.getElementById('analytics-locationsList');
      list.innerHTML = analyticsData.topRoutes.slice(0, 5).map(route =>
        `<li><span>${route.location}</span><strong>${route.combined_count}</strong></li>`
      ).join('');
    }

    function loadAnalyticsDataTable(params) {
      // Add pagination parameters if not present
      if (!params.has('page')) params.set('page', '1');
      if (!params.has('limit')) params.set('limit', document.getElementById('data-table-limit').value || '100');

      fetch('/api/analytics/transactions?' + params.toString())
        .then(response => response.json())
        .then(data => {
          createAnalyticsDataTable(data.transactions || [], data.pagination || {});
        })
        .catch(error => console.error('Error loading data table:', error));
    }

    function createAnalyticsDataTable(transactions, pagination) {
      const container = document.getElementById('analytics-data-table-container');
      if (!container) return;

      if (transactions.length === 0) {
        container.innerHTML = '<div class="no-data">No data available</div>';
        return;
      }

      let html = '<table class="data-table"><thead><tr>';
      const headers = ['Date', 'Time', 'Bus', 'From', 'To', 'Customer Type', 'Distance', 'Price', 'Qty', 'Discount', 'Total'];
      headers.forEach(header => {
        html += `<th>${header}</th>`;
      });
      html += '</tr></thead><tbody>';

      transactions.forEach(transaction => {
        html += '<tr>';
        html += `<td>${transaction.date}</td>`;
        html += `<td>${transaction.time}</td>`;
        html += `<td>${transaction.busID}</td>`;
        html += `<td>${transaction.from_location}</td>`;
        html += `<td>${transaction.to_location}</td>`;
        html += `<td>${transaction.customer_type}</td>`;
        html += `<td>${transaction.distance}km</td>`;
        html += `<td>$${transaction.price.toFixed(2)}</td>`;
        html += `<td>${transaction.qty}</td>`;
        html += `<td>$${transaction.discount.toFixed(2)}</td>`;
        html += `<td>$${transaction.total.toFixed(2)}</td>`;
        html += '</tr>';
      });

      html += '</tbody></table>';
      
      // Add pagination controls
      if (pagination.total_pages > 1) {
        html += '<div class="pagination-controls" style="margin-top: 20px; text-align: center; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px;">';

        // Previous button
        if (pagination.page > 1) {
          html += `<button class="btn-pagination" onclick="changeAnalyticsDataPage(${pagination.page - 1})">Â« Previous</button>`;
        }

        // Page number chooser
        const startPage = Math.max(1, pagination.page - 2);
        const endPage = Math.min(pagination.total_pages, pagination.page + 2);

        // First page if not in range
        if (startPage > 1) {
          html += `<button class="btn-pagination" onclick="changeAnalyticsDataPage(1)">1</button>`;
          if (startPage > 2) {
            html += '<span>...</span>';
          }
        }

        // Page numbers
        for (let i = startPage; i <= endPage; i++) {
          const activeClass = i === pagination.page ? ' active' : '';
          html += `<button class="btn-pagination${activeClass}" onclick="changeAnalyticsDataPage(${i})">${i}</button>`;
        }

        // Last page if not in range
        if (endPage < pagination.total_pages) {
          if (endPage < pagination.total_pages - 1) {
            html += '<span>...</span>';
          }
          html += `<button class="btn-pagination" onclick="changeAnalyticsDataPage(${pagination.total_pages})">${pagination.total_pages}</button>`;
        }

        // Next button
        if (pagination.page < pagination.total_pages) {
          html += `<button class="btn-pagination" onclick="changeAnalyticsDataPage(${pagination.page + 1})">Next Â»</button>`;
        }

        // Page info and jump to page
        html += `<div style="margin-left: 20px; display: flex; align-items: center; gap: 10px;">
          <span>Page ${pagination.page} of ${pagination.total_pages}</span>
          <span>|</span>
          <span>Go to page:</span>
          <input type="number" id="jump-to-page" min="1" max="${pagination.total_pages}" value="${pagination.page}" style="width: 60px; padding: 4px; text-align: center; border: 1px solid #ddd; border-radius: 3px;">
          <button class="btn-pagination" onclick="jumpToAnalyticsPage()">Go</button>
        </div>`;

        html += '</div>';
      } else {
        html += `<p style="margin-top: 10px; color: #666; text-align: center;">Showing ${transactions.length} of ${pagination.total || transactions.length} transactions</p>`;
      }

      container.innerHTML = html;
    }

    function changeAnalyticsDataPage(page) {
      // Get current filter parameters
      const params = new URLSearchParams();
      const fromDate = document.getElementById('analytics_from_date').value;
      const toDate = document.getElementById('analytics_to_date').value;
      const busId = document.getElementById('analytics_bus_filter').value;
      const customerType = document.getElementById('analytics_customer_filter').value;
      const userId = document.getElementById('analytics_user_filter').value;
      const search = document.getElementById('data-table-search').value;
      const limit = document.getElementById('data-table-limit').value;

      if (fromDate) params.append('from_date', fromDate);
      if (toDate) params.append('to_date', toDate);
      if (busId) params.append('bus_id', busId);
      if (customerType) params.append('customer_type', customerType);
      if (userId) params.append('user_id', userId);
      if (search) params.append('search', search);

      params.set('page', page.toString());
      params.set('limit', limit);

      loadAnalyticsDataTable(params);
    }

    function applyDataTableFilters() {
      const params = new URLSearchParams();
      const fromDate = document.getElementById('analytics_from_date').value;
      const toDate = document.getElementById('analytics_to_date').value;
      const busId = document.getElementById('analytics_bus_filter').value;
      const customerType = document.getElementById('analytics_customer_filter').value;
      const userId = document.getElementById('analytics_user_filter').value;
      const search = document.getElementById('data-table-search').value;
      const limit = document.getElementById('data-table-limit').value;

      if (fromDate) params.append('from_date', fromDate);
      if (toDate) params.append('to_date', toDate);
      if (busId) params.append('bus_id', busId);
      if (customerType) params.append('customer_type', customerType);
      if (userId) params.append('user_id', userId);
      if (search) params.append('search', search);

      params.set('page', '1'); // Reset to first page when applying filters
      params.set('limit', limit);

      loadAnalyticsDataTable(params);
    }

    function resetDataTableFilters() {
      document.getElementById('data-table-search').value = '';
      document.getElementById('data-table-limit').selectedIndex = 1; // Reset to 100
      // Reset to first page
      changeAnalyticsDataPage(1);
    }

    function changeAnalyticsDataLimit() {
      // Apply current filters with new limit
      applyDataTableFilters();
    }

    function jumpToAnalyticsPage() {
      const pageInput = document.getElementById('jump-to-page');
      const page = parseInt(pageInput.value);
      const maxPage = parseInt(pageInput.max);

      if (page >= 1 && page <= maxPage) {
        changeAnalyticsDataPage(page);
      } else {
        showToast('Please enter a valid page number');
      }
    }

    function setAnalyticsView(view) {
      document.querySelectorAll('.view-toggles .toggle-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(view + '-view').classList.add('active');

      document.querySelectorAll('.analytics-view-content').forEach(content => {
        content.style.display = 'none';
      });
      document.getElementById('analytics-' + view + '-content').style.display = 'block';

      // Load data if needed
      if (view === 'overview') {
        loadAnalyticsData();
      } else if (view === 'timeline' && !document.getElementById('analytics-timelineChart').chart) {
        const params = new URLSearchParams();
        const fromDate = document.getElementById('analytics_from_date').value;
        const toDate = document.getElementById('analytics_to_date').value;
        if (fromDate) params.append('from_date', fromDate);
        if (toDate) params.append('to_date', toDate);
        loadAnalyticsTimelineData('monthly', params);
      }
    }

    function togglePageFullscreen() {
      const pageElement = document.querySelector('.page');
      const fullscreenBtn = document.getElementById('pageFullscreenBtn');
      const icon = fullscreenBtn.querySelector('i');

      if (pageElement.classList.contains('page-fullscreen')) {
        // Exit fullscreen
        pageElement.classList.remove('page-fullscreen');
        icon.className = 'fas fa-expand';
        fullscreenBtn.title = 'Toggle Fullscreen';
      } else {
        // Enter fullscreen
        pageElement.classList.add('page-fullscreen');
        icon.className = 'fas fa-compress';
        fullscreenBtn.title = 'Exit Fullscreen';
      }
    }

    function updateAnalyticsTimelineChart() {
      const groupBy = document.getElementById('analytics-timelineGroupBy').value;
      const params = new URLSearchParams();
      const fromDate = document.getElementById('analytics_from_date').value;
      const toDate = document.getElementById('analytics_to_date').value;
      if (fromDate) params.append('from_date', fromDate);
      if (toDate) params.append('to_date', toDate);
      loadAnalyticsTimelineData(groupBy, params);
    }

    function resetAnalyticsFilters() {
      document.getElementById('analytics_from_date').value = '{{ from_date }}';
      document.getElementById('analytics_to_date').value = '{{ current_date }}';
      document.getElementById('analytics_bus_filter').selectedIndex = 0;
      document.getElementById('analytics_customer_filter').selectedIndex = 0;
      document.getElementById('analytics_user_filter').selectedIndex = 0;

      // Reset to overview view
      setAnalyticsView('overview');

      // Clear data
      analyticsData = null;
      document.getElementById('analytics-totalCustomers').textContent = '0';
      document.getElementById('analytics-totalRevenue').textContent = '$0';
      document.getElementById('analytics-avgTransaction').textContent = '$0';
      document.getElementById('analytics-topCustomerType').textContent = 'N/A';
      document.getElementById('analytics-topCustomerType').textContent = 'N/A';
    }

    // Initialize dashboard on page load
    document.addEventListener('DOMContentLoaded', function() {
      initializeDatepickers();
      loadFilterOptions();
      updateTimelineChart();
      applyFilters();

      // Initialize analytics filters
      const today = new Date();
      document.getElementById('analytics_from_date').value = today.toISOString().split('T')[0];
      document.getElementById('analytics_to_date').value = today.toISOString().split('T')[0];

      const modal = document.getElementById('reportModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeReportModal();
          }
        });
      }

      // Add escape key listener for fullscreen exit
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const pageElement = document.querySelector('.page');
          if (pageElement.classList.contains('page-fullscreen')) {
            togglePageFullscreen();
          }
        }
      });

      // Add search input event listener with debounce
      let searchTimeout;
      document.getElementById('data-table-search').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
          applyDataTableFilters();
        }, 300); // 300ms delay
      });
    });

    function initializeDatepickers() {
      const today = new Date();
      const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
      
      document.getElementById('filterFromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById('filterToDate').value = today.toISOString().split('T')[0];
      
      // Initialize analytics date filters
      document.getElementById('analytics_from_date').value = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById('analytics_to_date').value = today.toISOString().split('T')[0];
    }

    function loadFilterOptions() {
      // Fetch available buses and routes for filter dropdowns
      fetch('/api/manager/filter-options')
        .then(r => r.json())
        .then(data => {
          if (data.buses) {
            // Populate dashboard bus filter
            const busSelect = document.getElementById('filterBus');
            if (busSelect) {
              data.buses.forEach(bus => {
                const opt = document.createElement('option');
                opt.value = bus.id;
                opt.textContent = 'Bus ' + bus.number;
                busSelect.appendChild(opt);
              });
            }
            // Populate analytics bus filter
            const analyticsBusSelect = document.getElementById('analytics_bus_filter');
            if (analyticsBusSelect) {
              data.buses.forEach(bus => {
                const opt = document.createElement('option');
                opt.value = bus.id;
                opt.textContent = 'Bus ' + bus.number;
                analyticsBusSelect.appendChild(opt);
              });
            }
          }
          if (data.routes) {
            const routeSelect = document.getElementById('filterRoute');
            if (routeSelect) {
              data.routes.forEach(route => {
                const opt = document.createElement('option');
                opt.value = route.id;
                opt.textContent = route.from_location + ' â†’ ' + route.to_location;
                routeSelect.appendChild(opt);
              });
            }
          }
          if (data.customerTypes) {
            // Populate dashboard customer type filter
            const custSelect = document.getElementById('filterCustomerType');
            if (custSelect) {
              data.customerTypes.forEach(type => {
                const opt = document.createElement('option');
                opt.value = type.name;
                opt.textContent = type.name;
                custSelect.appendChild(opt);
              });
            }
            // Populate analytics customer type filter
            const analyticsCustSelect = document.getElementById('analytics_customer_filter');
            if (analyticsCustSelect) {
              data.customerTypes.forEach(type => {
                const opt = document.createElement('option');
                opt.value = type.name;
                opt.textContent = type.name;
                analyticsCustSelect.appendChild(opt);
              });
            }
          }
        })
        .catch(err => console.error('Error loading filter options:', err));

      // Fetch users for analytics user filter
      fetch('/api/manager/users')
        .then(r => r.json())
        .then(data => {
          const analyticsUserSelect = document.getElementById('analytics_user_filter');
          if (analyticsUserSelect && data.users) {
            data.users.forEach(user => {
              const opt = document.createElement('option');
              opt.value = user.userID;
              opt.textContent = user.userID + ' (' + user.userType + ')';
              analyticsUserSelect.appendChild(opt);
            });
          }
        })
        .catch(err => console.error('Error loading users for analytics:', err));
    }

    function updateTimelineFilters() {
      const groupBy = document.getElementById('timelineGroupBy').value;
      const filterSection = document.getElementById('timelineFilterSection');
      
      // Hide all filters
      document.getElementById('dailyFilters').style.display = 'none';
      document.getElementById('weeklyFilters').style.display = 'none';
      document.getElementById('monthlyFilters').style.display = 'none';
      document.getElementById('quarterlyFilters').style.display = 'none';
      document.getElementById('yearlyFilters').style.display = 'none';
      
      // Show appropriate filters and initialize them
      if (groupBy === 'daily') {
        filterSection.style.display = 'block';
        document.getElementById('dailyFilters').style.display = 'block';
        initializeDailyFilters();
      } else if (groupBy === 'weekly') {
        filterSection.style.display = 'block';
        document.getElementById('weeklyFilters').style.display = 'block';
        initializeYearFilters('timelineWeeklyYear');
      } else if (groupBy === 'monthly') {
        filterSection.style.display = 'block';
        document.getElementById('monthlyFilters').style.display = 'block';
        initializeYearRangeFilters('timelineMonthlyStartYear', 'timelineMonthlyEndYear');
      } else if (groupBy === 'quarterly') {
        filterSection.style.display = 'block';
        document.getElementById('quarterlyFilters').style.display = 'block';
        initializeYearRangeFilters('timelineQuarterlyStartYear', 'timelineQuarterlyEndYear');
      } else if (groupBy === 'yearly') {
        filterSection.style.display = 'block';
        document.getElementById('yearlyFilters').style.display = 'block';
        initializeYearRangeFilters('timelineYearlyStart', 'timelineYearlyEnd');
      }
      
      updateTimelineChart();
    }

    function initializeDailyFilters() {
      const today = new Date();
      const ninetyDaysAgo = new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000);
      document.getElementById('timelineDailyStart').value = ninetyDaysAgo.toISOString().split('T')[0];
      document.getElementById('timelineDailyEnd').value = today.toISOString().split('T')[0];
      initializeYearFilters('timelineDailyYear');
    }

    function initializeYearFilters(selectId) {
      const select = document.getElementById(selectId);
      const currentYear = new Date().getFullYear();
      
      // Clear existing options except the first one
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      // Add years from 2020 to current year
      for (let year = currentYear; year >= 2020; year--) {
        const opt = document.createElement('option');
        opt.value = year;
        opt.textContent = year;
        select.appendChild(opt);
      }
    }

    function initializeYearRangeFilters(startId, endId) {
      const currentYear = new Date().getFullYear();
      document.getElementById(startId).value = currentYear - 2;
      document.getElementById(endId).value = currentYear;
    }

    function updateTimelineChart() {
      const groupBy = document.getElementById('timelineGroupBy').value;
      const params = new URLSearchParams();
      params.append('group_by', groupBy);
      
      // Add time-specific filters
      if (groupBy === 'daily') {
        params.append('daily_start', document.getElementById('timelineDailyStart').value);
        params.append('daily_end', document.getElementById('timelineDailyEnd').value);
        const year = document.getElementById('timelineDailyYear').value;
        const month = document.getElementById('timelineDailyMonth').value;
        if (year) params.append('daily_year', year);
        if (month) params.append('daily_month', month);
      } else if (groupBy === 'weekly') {
        const year = document.getElementById('timelineWeeklyYear').value;
        const month = document.getElementById('timelineWeeklyMonth').value;
        if (year) params.append('weekly_year', year);
        if (month) params.append('weekly_month', month);
      } else if (groupBy === 'monthly') {
        params.append('monthly_start', document.getElementById('timelineMonthlyStartYear').value);
        params.append('monthly_end', document.getElementById('timelineMonthlyEndYear').value);
      } else if (groupBy === 'quarterly') {
        params.append('quarterly_start', document.getElementById('timelineQuarterlyStartYear').value);
        params.append('quarterly_end', document.getElementById('timelineQuarterlyEndYear').value);
      } else if (groupBy === 'yearly') {
        params.append('yearly_start', document.getElementById('timelineYearlyStart').value);
        params.append('yearly_end', document.getElementById('timelineYearlyEnd').value);
      }
      
      fetch(`/api/manager/timeline-data?${params.toString()}`)
        .then(r => r.json())
        .then(data => {
          renderTimelineChart(data, groupBy);
        })
        .catch(err => {
          console.error('Error loading timeline data:', err);
          showToast('Failed to load timeline data');
        });
    }

    function renderTimelineChart(data, groupBy) {
      const ctx = document.getElementById('timelineChart').getContext('2d');
      
      // Destroy existing chart if it exists
      if (timelineChart) {
        timelineChart.destroy();
      }

      const labels = data.labels || [];
      const revenueData = data.revenue || [];
      const customerData = data.customers || [];

      // Diverse color palette for timeline
      const revenueColor = '#1e5fa0';
      const customerColor = '#27a745';

      timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Revenue ($)',
              data: revenueData,
              borderColor: revenueColor,
              backgroundColor: 'rgba(30, 95, 160, 0.08)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 5,
              pointBackgroundColor: revenueColor,
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointHoverRadius: 7,
              yAxisID: 'y'
            },
            {
              label: 'Customer Count',
              data: customerData,
              borderColor: customerColor,
              backgroundColor: 'rgba(39, 167, 69, 0.08)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 5,
              pointBackgroundColor: customerColor,
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointHoverRadius: 7,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                boxWidth: 12,
                padding: 15,
                font: {
                  size: 13,
                  weight: '600'
                },
                color: '#0d2b4d'
              }
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Revenue ($)',
                font: { size: 12, weight: '600' },
                color: revenueColor
              },
              ticks: {
                color: revenueColor,
                font: { size: 11 }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Customer Count',
                font: { size: 12, weight: '600' },
                color: customerColor
              },
              ticks: {
                color: customerColor,
                font: { size: 11 }
              },
              grid: {
                drawOnChartArea: false
              }
            },
            x: {
              ticks: {
                font: { size: 11 },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          }
        }
      });
    }

    function applyFilters() {
      currentFilters = {
        fromDate: document.getElementById('filterFromDate').value,
        toDate: document.getElementById('filterToDate').value,
        bus: document.getElementById('filterBus').value,
        route: document.getElementById('filterRoute').value,
        customerType: document.getElementById('filterCustomerType').value
      };

      loadDashboardData();
    }

    function resetFilters() {
      initializeDatepickers();
      document.getElementById('filterBus').value = '';
      document.getElementById('filterRoute').value = '';
      document.getElementById('filterCustomerType').value = '';
      currentFilters = {
        fromDate: '',
        toDate: '',
        bus: '',
        route: '',
        customerType: ''
      };
      loadDashboardData();
    }

    function loadDashboardData() {
      const params = new URLSearchParams();
      if (currentFilters.fromDate) params.append('from_date', currentFilters.fromDate);
      if (currentFilters.toDate) params.append('to_date', currentFilters.toDate);
      if (currentFilters.bus) params.append('bus_id', currentFilters.bus);
      if (currentFilters.route) params.append('route_id', currentFilters.route);
      if (currentFilters.customerType) params.append('customer_type', currentFilters.customerType);

      const url = '/api/manager/dashboard-data?' + params.toString();

      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (data) {
            updateMetrics(data);
            updateCustomerTypeChart(data.customerTypes);
            updateRoutesChart(data.topRoutes);
          }
        })
        .catch(err => {
          console.error('Error loading dashboard data:', err);
          showToast('Failed to load dashboard data');
        });
    }

    function updateMetrics(data) {
      document.getElementById('totalCustomers').innerText = data.totalCustomers || 0;
      document.getElementById('totalRevenue').innerText = '$' + (data.totalRevenue || 0).toFixed(2);
    }

    function updateCustomerTypeChart(customerTypes) {
      const ctx = document.getElementById('customerTypeChart').getContext('2d');
      
      // Destroy existing chart if it exists
      if (customerTypeChart) {
        customerTypeChart.destroy();
      }

      const labels = customerTypes.map(ct => ct.name);
      const data = customerTypes.map(ct => ct.count);
      const colors = [
        '#1e5fa0',
        '#27a745',
        '#f39c12',
        '#e74c3c',
        '#9b59b6',
        '#16a085',
        '#2980b9',
        '#8e44ad',
        '#c0392b',
        '#d35400'
      ];

      customerTypeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, data.length),
            borderColor: '#ffffff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });

      // Update customer types list
      const listHTML = customerTypes.map((ct, idx) => `
        <li>
          <span class="type-label"><span class="color-box" style="background-color: ${colors[idx % colors.length]};"></span>${ct.name}</span>
          <span class="type-count">${ct.count} customers</span>
        </li>
      `).join('');
      document.getElementById('customerTypesList').innerHTML = listHTML;
    }

    function updateRoutesChart(topRoutes) {
      const ctx = document.getElementById('routesChart').getContext('2d');
      
      // Destroy existing chart if it exists
      if (routesChart) {
        routesChart.destroy();
      }

      const labels = topRoutes.map(r => r.location);
      const fromData = topRoutes.map(r => r.from_count);
      const toData = topRoutes.map(r => r.to_count);
      const combinedData = topRoutes.map(r => r.combined_count);

      routesChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Departures From',
              data: fromData,
              backgroundColor: '#1e5fa0',
              borderRadius: 6,
              borderSkipped: false
            },
            {
              label: 'Arrivals To',
              data: toData,
              backgroundColor: '#27a745',
              borderRadius: 6,
              borderSkipped: false
            },
            {
              label: 'Total',
              data: combinedData,
              backgroundColor: '#f39c12',
              borderRadius: 6,
              borderSkipped: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });

      // Update routes list
      const listHTML = topRoutes.map((route) => `
        <li>
          <span class="route-name">${route.location}</span>
          <div class="route-stat">
            <span class="stat-badge from">${route.from_count}</span>
          </div>
          <div class="route-stat">
            <span class="stat-badge to">${route.to_count}</span>
          </div>
          <div class="route-stat">
            <span class="stat-badge combined">${route.combined_count}</span>
          </div>
        </li>
      `).join('');
      
      // Add header for list
      const headerHTML = `
        <li style="border-bottom: 2px solid #0d2b4d; padding-bottom: 8px; margin-bottom: 8px; font-weight: 700; color: #0d2b4d; grid-template-columns: 2fr 1fr 1fr 1fr;">
          <span style="color: #0d2b4d;">Location</span>
          <span style="text-align: center; color: #1e5fa0;">From</span>
          <span style="text-align: center; color: #27a745;">To</span>
          <span style="text-align: center; color: #f39c12;">Total</span>
        </li>
      `;
      document.getElementById('routesList').innerHTML = headerHTML + listHTML;
    }

    function exportDashboard() {
      // Check if analytics data table has been loaded
      const dataTableContainer = document.getElementById('analytics-data-table-container');
      const hasDataTable = dataTableContainer && dataTableContainer.querySelector('table');

      if (!hasDataTable) {
        showToast('Please use Analytics first to load data before exporting. Switch to the Analytics tab, select "Data Table" view, and apply filters.', 'error');
        return;
      }

      // Export the analytics data table
      const params = new URLSearchParams();

      // Use analytics filters
      const fromDate = document.getElementById('analytics_from_date').value;
      const toDate = document.getElementById('analytics_to_date').value;
      const busFilter = document.getElementById('analytics_bus_filter').value;
      const customerFilter = document.getElementById('analytics_customer_filter').value;
      const userFilter = document.getElementById('analytics_user_filter').value;

      if (fromDate) params.append('from_date', fromDate);
      if (toDate) params.append('to_date', toDate);
      if (busFilter) params.append('bus_id', busFilter);
      if (customerFilter) params.append('customer_type', customerFilter);
      if (userFilter) params.append('user_id', userFilter);

      // Add pagination parameters to export all data (not just current page)
      params.append('limit', '10000'); // Export up to 10,000 records
      params.append('page', '1');

      window.location.href = '/api/manager/export?' + params.toString();
      showToast('Exporting analytics data...');
    }
  </script>
</body>
</html>
